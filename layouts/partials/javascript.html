<!-- Similar to webpack defines plugin, perform string replacements at build time to provide global variables. -->
{{ $CI_COMMIT_SHORT_SHA := getenv `"CI_COMMIT_SHORT_SHA"` | default `""` }}
{{ $defines := dict "CI_COMMIT_SHORT_SHA" $CI_COMMIT_SHORT_SHA "process.env.NODE_ENV" `"development"` "process.env.RESET_APP_DATA_TIMER" `10` }}

{{ $isLocalServer := site.IsServer }}
{{ $jsInput := "scripts/main.js" }}
{{ $compiledJS := "" }}

{{ $devOptions := dict "defines" $defines "sourceMap" "inline" }}
{{ $productionOptions := dict "defines" $defines "sourceMap" "inline" "minify" true }}
{{ $options := cond $isLocalServer $devOptions $productionOptions }}
{{ $jQuery := resources.Get "scripts/vendor/jquery.min.js" }}
{{ $popperJS := resources.Get "scripts/vendor/popper.min.js" }}
{{ $bootstrapJS := resources.Get "scripts/vendor/bootstrap.min.js" | js.Build $options }}
{{ $ddLibs := resources.Get "scripts/components/dd-browser-logs-rum.js" | js.Build $options }}
{{ $vendor := slice $jQuery $popperJS $bootstrapJS | resources.Concat "scripts/vendor/vendor.js" }}

<script src="{{ $vendor.RelPermalink }}"></script>

<!-- Because the version property we provide to DD config is a commit hash, we dont use fingerprinting when building Logs and RUM.  Fingerprint would change with each deploy, causing all the HTML to deploy every build, which slows down the pipeline quite a bit. -->
<script src="{{ $ddLibs.RelPermalink }}"></script>

<!-- The docsearch.js lib requires this -->
<script>global = globalThis;</script>

{{ if $isLocalServer }}
  {{ $compiledJS = resources.Get $jsInput | js.Build $options }}
{{ else }}
  {{ $compiledJS = resources.Get $jsInput | js.Build $options | resources.Fingerprint "sha512" }}
{{ end }}

<script src="{{ $compiledJS.RelPermalink }}" defer {{ if ne $isLocalServer true }}integrity="{{ $compiledJS.Data.Integrity }}"{{ end }}></script>

{{ if eq .File.BaseFileName "search" }}
    {{ $searchJS := resources.Get "scripts/components/search.js" | js.Build $options }}
    <script src="{{ $searchJS.RelPermalink }}" defer {{ if ne $isLocalServer true }}integrity="{{ $searchJS.Data.Integrity }}"{{ end }}></script>
{{ end }}