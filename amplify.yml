version: 1
frontend:
  phases:
    preBuild:
      commands:
        - curl -OL https://golang.org/dl/go1.15.7.linux-amd64.tar.gz
        - tar -C /usr/local -xzf ./go1.15.7.linux-amd64.tar.gz
        - wget https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz
        - tar -xf hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz hugo
        - mv hugo /usr/bin/hugo
        - rm -rf hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz
        - rm -rf site/static/video site/static/pdf site/static/admin site/static/img/video
        - hugo version
        - nvm install $NODE_VERSION
        - yarn install --frozen-lockfile --cache-folder .yarn
    build:
      commands:
        - PATH=$PATH:/usr/local/go/bin
        - git config --global url."https://guacbot:$GITHUB_TOKEN@github.com/".insteadOf "https://github.com/"
        - yarn run build:webpack
        - HUGO_RELATIVEURLS=true hugo -b / -v --minify --gc --environment $CI_ENVIRONMENT_NAME
  artifacts:
    # IMPORTANT - Please verify your build output directory
    baseDirectory: /public
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/
      - .yarn
