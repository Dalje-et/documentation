<!-- Similar to webpack defines plugin, perform string replacements at build time to provide global variables. -->
{{/* $defines := dict "CI_COMMIT_SHORT_SHA" (getenv "CI_COMMIT_SHORT_SHA" | default `""`) "process.env.NODE_ENV" `"development"` "process.env.RESET_APP_DATA_TIMER" `10` */}}

<!-- Evaluates to empty string if variable is not set -->
{{ $CI_COMMIT_SHORT_SHA := getenv `"CI_COMMIT_SHORT_SHA"` | default `""` }}

{{ $defines := dict "CI_COMMIT_SHORT_SHA" $CI_COMMIT_SHORT_SHA "process.env.NODE_ENV" `"development"` "process.env.RESET_APP_DATA_TIMER" `10` }}

{{ $isLocalServer := site.IsServer }}
{{ $jsInput := "scripts/main.js" }}
{{ $devOptions := dict "defines" $defines "sourceMap" "inline" }}
{{ $productionOptions := dict "defines" $defines "sourceMap" "inline" "minify" true }}
{{ $options := cond $isLocalServer $devOptions $productionOptions }}
{{ $compiledJS := resources.Get $jsInput | js.Build $options }}
{{ $jQuery := resources.Get "scripts/jquery.min.js" }}

<script src="{{ $jQuery.RelPermalink }}"></script>

<!-- The docsearch.js lib requires this for some reason -->
<script>global = globalThis;</script>

{{ if $isLocalServer }}
  <script src="{{ $compiledJS.RelPermalink }}" defer></script>
{{ else }}
  {{ $productionJS := $compiledJS | resources.Fingerprint "sha512" }}
  <script src="{{ $productionJS.RelPermalink }}" integrity="{{ $productionJS.Data.Integrity }}" defer></script>
{{ end }}