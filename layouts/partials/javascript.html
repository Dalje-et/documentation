<!-- Similar to webpack defines plugin, perform string replacements at build time to provide global variables. -->
{{ $defines := dict "process.env.NODE_ENV" `"development"` "process.env.RESET_APP_DATA_TIMER" `10` }}
{{ $CI_COMMIT_SHORT_SHA := getenv "CI_COMMIT_SHORT_SHA" | default "" }}
{{ $isLocalServer := site.IsServer }}
{{ $jsInput := "scripts/main.js" }}
{{ $compiledMainJS := "" }}

<!-- Currently used in dd-browser-logs-rum.  Provides params that can be imported directly by JS files.  Info: https://gohugo.io/hugo-pipes/js/#options -->
{{ $jsParamsDict := (dict "params" (dict "CI_COMMIT_SHORT_SHA" $CI_COMMIT_SHORT_SHA)) }}

{{ $devOptions := dict "defines" $defines "sourceMap" "external" }}
{{ $liveOptions := dict "defines" $defines "sourceMap" "external" "minify" true }}
{{ $options := cond $isLocalServer $devOptions $liveOptions }}
{{ $jQuery := resources.Get "scripts/vendor/jquery.min.js" }}
{{ $popperJS := resources.Get "scripts/vendor/popper.min.js" }}
{{ $bootstrapJS := resources.Get "scripts/vendor/bootstrap.min.js" }}
{{ $ddLibs := resources.Get "scripts/components/dd-browser-logs-rum.js" | js.Build (merge $options $jsParamsDict) }}
{{ $vendor := slice $jQuery $popperJS $bootstrapJS | resources.Concat "scripts/vendor/vendor.js" }}

<script src="{{ $vendor.RelPermalink }}"></script>

<!-- Because the version property we provide to DD config is a commit hash, we dont use fingerprinting when building Logs and RUM.  Fingerprint would change with each deploy, causing all the HTML to deploy every build, which slows down the pipeline quite a bit. -->
<script src="{{ $ddLibs.RelPermalink }}"></script>

<!-- The docsearch.js lib requires this -->
<script>global = globalThis;</script>

{{ if $isLocalServer }}
  {{ $compiledMainJS = resources.Get $jsInput | js.Build $options }}
{{ else }}
  {{ $compiledMainJS = resources.Get $jsInput | js.Build $options | resources.Fingerprint "sha512" }}
{{ end }}

<script src="{{ $compiledMainJS.RelPermalink }}" defer {{ if ne $isLocalServer true }}integrity="{{ $compiledMainJS.Data.Integrity }}"{{ end }}></script>

{{ if eq .File.BaseFileName "search" }}
  {{ $compiledSearchJS := "" }}

  {{ if $isLocalServer }}
    {{ $compiledSearchJS = resources.Get "scripts/components/search.js" | js.Build $options }}
  {{ else }}
    {{ $compiledSearchJS = resources.Get "scripts/components/search.js" | js.Build $options | resources.Fingerprint "sha512" }}
  {{ end }}

  <script src="{{ $compiledSearchJS.RelPermalink }}" defer {{ if ne $isLocalServer true }}integrity="{{ $compiledSearchJS.Data.Integrity }}"{{ end }}></script>
{{ end }}